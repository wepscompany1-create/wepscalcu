<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>WEPS â€“ Freight-Grade Customs Calculator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #eef2ff, #f8fafc);
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1200px;
      margin: 30px auto;
      background: #fff;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.12);
    }
    h1 {
      text-align: center;
      margin-bottom: 24px;
      font-size: 26px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    .field {
      display: flex;
      flex-direction: column;
      background: #f9fafb;
      padding: 10px;
      border-radius: 10px;
    }
    .field label {
      font-size: 13px;
      margin-bottom: 6px;
      color: #374151;
      font-weight: bold;
    }
    .field input, .field select {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }
    .actions {
      text-align: center;
      margin-top: 20px;
    }
    button {
      padding: 14px 40px;
      border-radius: 14px;
      border: none;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #fff;
      font-size: 17px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(37,99,235,0.35);
    }

    .results {
      margin-top: 30px;
      background: #f9fafb;
      padding: 18px;
      border-radius: 14px;
    }

    .results table {
      width: 100%;
      border-collapse: collapse;
    }
    .results th, .results td {
      padding: 11px;
      border-bottom: 1px solid #e5e7eb;
      text-align: right;
      font-size: 14px;
    }

    .section { background: #eef2ff; font-weight: bold; }
    .total { background: #111827; color: #fff; font-size: 18px; font-weight: bold; }

    /* Color Coding */
    .tariff { background: #fef3c7; }
    .sales { background: #dbeafe; }
    .vat { background: #dcfce7; }
    .profit { background: #ede9fe; }
    .funds { background: #fee2e2; }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 15px;
      font-size: 13px;
    }
    .legend span {
      padding: 6px 10px;
      border-radius: 8px;
      font-weight: bold;
    }

    .note {
      margin-top: 12px;
      color: #b91c1c;
      font-size: 13px;
    }

    /* Readonly fields styling */
    input[readonly] {
      background: #e0e7ff !important;
      cursor: not-allowed !important;
      border: 2px solid #818cf8 !important;
    }

    .loading-indicator {
      text-align: center;
      padding: 10px;
      color: #2563eb;
      font-size: 14px;
      font-weight: bold;
    }

    .error-message {
      background: #fee2e2;
      color: #b91c1c;
      padding: 12px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 13px;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¬Ù…Ø§Ø±Ùƒ Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ© â€“ WEPS</h1>

  <div id="loadingIndicator" class="loading-indicator" style="display: none;">
    â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù Ù…Ù† Monday.com...
  </div>

  <div id="errorMessage" class="error-message" style="display: none;"></div>

  <div class="grid">
    <div class="field">
      <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©</label>
      <select id="commodityType">
        <option value="">-- Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© --</option>
      </select>
    </div>

    <div class="field">
      <label>Ø§Ù„ÙˆØ¬Ù‡Ø© (Ù…Ø¯Ù† Ø§Ù„ÙŠÙ…Ù†)</label>
      <select id="region">
        <optgroup label="ğŸ‡¾ğŸ‡ª Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©">
          <option value="ØµÙ†Ø¹Ø§Ø¡">ØµÙ†Ø¹Ø§Ø¡</option>
          <option value="Ø£Ù…Ø§Ù†Ø© Ø§Ù„Ø¹Ø§ØµÙ…Ø©">Ø£Ù…Ø§Ù†Ø© Ø§Ù„Ø¹Ø§ØµÙ…Ø©</option>
          <option value="ØµØ¹Ø¯Ø©">ØµØ¹Ø¯Ø©</option>
          <option value="Ø¹Ù…Ø±Ø§Ù†">Ø¹Ù…Ø±Ø§Ù†</option>
          <option value="Ø­Ø¬Ø©">Ø­Ø¬Ø©</option>
          <option value="Ø§Ù„Ù…Ø­ÙˆÙŠØª">Ø§Ù„Ù…Ø­ÙˆÙŠØª</option>
          <option value="Ø±ÙŠÙ…Ø©">Ø±ÙŠÙ…Ø©</option>
          <option value="Ø°Ù…Ø§Ø±">Ø°Ù…Ø§Ø±</option>
          <option value="Ø¥Ø¨">Ø¥Ø¨</option>
          <option value="ØªØ¹Ø²">ØªØ¹Ø²</option>
          <option value="Ø§Ù„Ø­Ø¯ÙŠØ¯Ø©">Ø§Ù„Ø­Ø¯ÙŠØ¯Ø©</option>
          <option value="Ù…Ø£Ø±Ø¨">Ù…Ø£Ø±Ø¨</option>
          <option value="Ø§Ù„Ø¬ÙˆÙ">Ø§Ù„Ø¬ÙˆÙ</option>
          <option value="Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡">Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡</option>
        </optgroup>
        <optgroup label="ğŸ‡¾ğŸ‡ª Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠØ©">
          <option value="Ø¹Ø¯Ù†">Ø¹Ø¯Ù†</option>
          <option value="Ù„Ø­Ø¬">Ù„Ø­Ø¬</option>
          <option value="Ø£Ø¨ÙŠÙ†">Ø£Ø¨ÙŠÙ†</option>
          <option value="Ø§Ù„Ø¶Ø§Ù„Ø¹">Ø§Ù„Ø¶Ø§Ù„Ø¹</option>
          <option value="Ø´Ø¨ÙˆØ©">Ø´Ø¨ÙˆØ©</option>
          <option value="Ø­Ø¶Ø±Ù…ÙˆØª">Ø­Ø¶Ø±Ù…ÙˆØª</option>
          <option value="Ø§Ù„Ù…Ù‡Ø±Ø©">Ø§Ù„Ù…Ù‡Ø±Ø©</option>
          <option value="Ø³Ù‚Ø·Ø±Ù‰">Ø³Ù‚Ø·Ø±Ù‰</option>
        </optgroup>
      </select>
    </div>

    <div class="field">
      <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± (CIF)</label>
      <input type="number" id="cifUsd" value="26350">
    </div>

    <div class="field">
      <label>Ø§Ù„ØªØ¹Ø±ÙØ© Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ© %</label>
      <input type="number" id="tariffRate" value="5">
    </div>

    <div class="field">
      <label>Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ â€“ Ø´Ù…Ø§Ù„</label>
      <input type="number" id="customsFxNorth" value="250" readonly>
    </div>

    <div class="field">
      <label>Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ â€“ Ø¬Ù†ÙˆØ¨</label>
      <input type="number" id="customsFxSouth" value="750" readonly>
    </div>

    <div class="field">
      <label>Ø³Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚ â€“ Ø´Ù…Ø§Ù„</label>
      <input type="number" id="avgFxRate" value="534" readonly>
    </div>

    <div class="field">
      <label>Ø³Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚ Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± â€“ Ø¬Ù†ÙˆØ¨</label>
      <input type="number" id="southMarketFx" value="750" readonly>
    </div>

    <div class="field">
      <label>Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª %</label>
      <input type="number" id="salesTaxRate" value="5">
    </div>

    <div class="field">
      <label>Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© %</label>
      <input type="number" id="vatRate" value="5">
    </div>

    <div class="field">
      <label>Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ %</label>
      <input type="number" id="profitTaxRate" value="3">
    </div>
  </div>

  <div class="actions">
    <button onclick="runCalculation()">ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</button>
  </div>

  <div class="results" id="results"></div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ© ÙˆØ§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©) -->
  <div class="results" id="baseValues"></div>

  <div class="legend">
    <span class="tariff">Ø§Ù„ØªØ¹Ø±ÙØ©</span>
    <span class="sales">Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
    <span class="vat">Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©</span>
    <span class="profit">Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</span>
    <span class="funds">Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚</span>
  </div>

  <div class="note">
    âš ï¸ ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ ØºØ±Ø§Ù…Ø§Øª Ø¹Ù†Ø¯ Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„Ù‚ÙŠÙ…Ø© Ø£Ùˆ Ø§Ù„ÙƒÙ…ÙŠØ© Ø¹Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ (60% ÙØ±Ù‚ Ù‚ÙŠÙ…Ø© â€“ 40% ÙØ±Ù‚ ÙƒÙ…ÙŠØ©) + 10% Ø­ØµØ© Ù…Ø®Ø¨Ø±ÙŠÙ†.
  </div>
</div>

<script>
// Monday.com API Configuration
const MONDAY_API_TOKEN = "eyJhbGciOiJIUzI1NiJ9.eyJ0aWQiOjU2NjIyMzEyNiwiYWFpIjoxMSwidWlkIjo3Mzg2OTI3NiwiaWFkIjoiMjAyNS0wOS0yNFQxODoyNjoxNi4wMDBaIiwicGVyIjoibWU6d3JpdGUiLCJhY3RpZCI6ODQ1ODk5OSwicmduIjoidXNlMSJ9.GeSStga5orLvTsrxMsh1VYK5eNldRINHt9kkxNS9bJo";
const MONDAY_BOARD_ID_RATES = "7406444729";  // Board for exchange rates
const MONDAY_BOARD_ID_COMMODITIES = "7406443393";  // Board for commodity types
const MONDAY_API_URL = "https://api.monday.com/v2";

// Yemen Provinces Classification
const NORTHERN_PROVINCES = [
  "ØµÙ†Ø¹Ø§Ø¡", "Ø£Ù…Ø§Ù†Ø© Ø§Ù„Ø¹Ø§ØµÙ…Ø©", "ØµØ¹Ø¯Ø©", "Ø¹Ù…Ø±Ø§Ù†", "Ø­Ø¬Ø©", "Ø§Ù„Ù…Ø­ÙˆÙŠØª", 
  "Ø±ÙŠÙ…Ø©", "Ø°Ù…Ø§Ø±", "Ø¥Ø¨", "ØªØ¹Ø²", "Ø§Ù„Ø­Ø¯ÙŠØ¯Ø©", "Ù…Ø£Ø±Ø¨", "Ø§Ù„Ø¬ÙˆÙ", "Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡"
];

const SOUTHERN_PROVINCES = [
  "Ø¹Ø¯Ù†", "Ù„Ø­Ø¬", "Ø£Ø¨ÙŠÙ†", "Ø§Ù„Ø¶Ø§Ù„Ø¹", "Ø´Ø¨ÙˆØ©", "Ø­Ø¶Ø±Ù…ÙˆØª", 
  "Ø§Ù„Ù…Ù‡Ø±Ø©", "Ø³Ù‚Ø·Ø±Ù‰"
];

// Helper function to determine if province is northern
function isNorthernProvince(province) {
  return NORTHERN_PROVINCES.includes(province);
}

// Column IDs mapping for Exchange Rates Board
const COLUMN_IDS = {
  southMarketFx: "numeric_mkyhrswn",    // Ø³Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚ Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± â€“ Ø¬Ù†ÙˆØ¨
  customsFxNorth: "numeric_mkyhqzar",   // Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ â€“ Ø´Ù…Ø§Ù„
  customsFxSouth: "numeric_mkyhhzkf",   // Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ â€“ Ø¬Ù†ÙˆØ¨
  avgFxRate: "numeric_mkyhqmtz"         // Ø³Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚ â€“ Ø´Ù…Ø§Ù„
};

// Column IDs mapping for Commodities Board
const COMMODITY_COLUMN_IDS = {
  commodityType: "text_mkwdfwyy",           // Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©
  tariffSouth: "numeric_mkwbvqc1",          // Ø§Ù„ØªØ¹Ø±ÙØ© Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ© - Ø¬Ù†ÙˆØ¨
  tariffNorth: "numeric_mkwyy2fn",          // Ø§Ù„ØªØ¹Ø±ÙØ© Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ© - Ø´Ù…Ø§Ù„
  salesTax: "numeric_mkwxk61m",             // Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
  vat: "numeric_mkwyn5b8",                  // Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©
  profitTax: "numeric_mkwyw5dx"             // Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­
};

// Global storage for commodity data
let commoditiesData = [];

// Fetch exchange rates from Monday.com
async function fetchFromMonday() {
  const loadingIndicator = document.getElementById("loadingIndicator");
  const errorMessage = document.getElementById("errorMessage");
  
  // Show loading indicator
  loadingIndicator.style.display = "block";
  errorMessage.style.display = "none";

  try {
    const query = `
      query {
        boards(ids: [${MONDAY_BOARD_ID_RATES}]) {
          items_page(limit: 1) {
            items {
              id
              name
              column_values {
                id
                value
                text
              }
            }
          }
        }
      }
    `;

    const response = await fetch(MONDAY_API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": MONDAY_API_TOKEN
      },
      body: JSON.stringify({ query })
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    
    if (data.errors) {
      throw new Error(data.errors[0].message);
    }

    const items = data.data?.boards?.[0]?.items_page?.items;
    
    if (!items || items.length === 0) {
      throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù„ÙˆØ­Ø©");
    }

    const firstItem = items[0];
    const columnValues = firstItem.column_values;

    // Map column values to input fields
    columnValues.forEach(col => {
      let inputId = null;
      
      // Find matching input field
      if (col.id === COLUMN_IDS.southMarketFx) {
        inputId = "southMarketFx";
      } else if (col.id === COLUMN_IDS.customsFxNorth) {
        inputId = "customsFxNorth";
      } else if (col.id === COLUMN_IDS.customsFxSouth) {
        inputId = "customsFxSouth";
      } else if (col.id === COLUMN_IDS.avgFxRate) {
        inputId = "avgFxRate";
      }

      if (inputId && col.text) {
        const value = parseFloat(col.text);
        if (!isNaN(value)) {
          document.getElementById(inputId).value = value;
        }
      }
    });

    // Hide loading indicator
    loadingIndicator.style.display = "none";
    
    console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Monday.com");

  } catch (error) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
    
    // Show error message
    loadingIndicator.style.display = "none";
    errorMessage.style.display = "block";
    errorMessage.innerHTML = `
      âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù Ù…Ù† Monday.com: ${error.message}<br>
      Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©.
    `;
  }
}

// Fetch commodity types from Monday.com
async function fetchCommodityTypes() {
  const commodityDropdown = document.getElementById("commodityType");
  const loadingIndicator = document.getElementById("loadingIndicator");
  const errorMessage = document.getElementById("errorMessage");

  try {
    const query = `
      query {
        boards(ids: [${MONDAY_BOARD_ID_COMMODITIES}]) {
          items_page(limit: 500) {
            items {
              id
              name
              column_values {
                id
                value
                text
              }
            }
          }
        }
      }
    `;

    const response = await fetch(MONDAY_API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": MONDAY_API_TOKEN
      },
      body: JSON.stringify({ query })
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    
    if (data.errors) {
      throw new Error(data.errors[0].message);
    }

    const items = data.data?.boards?.[0]?.items_page?.items;
    
    if (!items || items.length === 0) {
      throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†ÙˆØ§Ø¹ Ø¨Ø¶Ø§Ø¦Ø¹ ÙÙŠ Ø§Ù„Ù„ÙˆØ­Ø©");
    }

    // Store commodity data globally
    commoditiesData = items.map(item => {
      const commodityData = {
        id: item.id,
        name: item.name
      };

      // Extract column values
      item.column_values.forEach(col => {
        if (col.id === COMMODITY_COLUMN_IDS.commodityType) {
          commodityData.commodityType = col.text || item.name;
        } else if (col.id === COMMODITY_COLUMN_IDS.tariffSouth) {
          commodityData.tariffSouth = col.text ? parseFloat(col.text) : 0;
        } else if (col.id === COMMODITY_COLUMN_IDS.tariffNorth) {
          commodityData.tariffNorth = col.text ? parseFloat(col.text) : 0;
        } else if (col.id === COMMODITY_COLUMN_IDS.salesTax) {
          commodityData.salesTax = col.text ? parseFloat(col.text) : 0;
        } else if (col.id === COMMODITY_COLUMN_IDS.vat) {
          commodityData.vat = col.text ? parseFloat(col.text) : 0;
        } else if (col.id === COMMODITY_COLUMN_IDS.profitTax) {
          commodityData.profitTax = col.text ? parseFloat(col.text) : 0;
        }
      });

      return commodityData;
    });

    // Populate dropdown
    commodityDropdown.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© --</option>';
    commoditiesData.forEach(commodity => {
      const option = document.createElement("option");
      option.value = commodity.id;
      option.textContent = commodity.commodityType || commodity.name;
      commodityDropdown.appendChild(option);
    });

    console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹ Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Monday.com");

  } catch (error) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹:", error);
    
    // Show error message
    errorMessage.style.display = "block";
    errorMessage.innerHTML += `<br>âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹: ${error.message}`;
  }
}

// Handle commodity type selection
function onCommodityChange() {
  const commodityDropdown = document.getElementById("commodityType");
  const selectedCommodityId = commodityDropdown.value;

  if (!selectedCommodityId) {
    // Clear and unlock fields if no commodity is selected
    document.getElementById("tariffRate").value = "";
    document.getElementById("salesTaxRate").value = "";
    document.getElementById("vatRate").value = "";
    document.getElementById("profitTaxRate").value = "";
    
    document.getElementById("tariffRate").removeAttribute("readonly");
    document.getElementById("salesTaxRate").removeAttribute("readonly");
    document.getElementById("vatRate").removeAttribute("readonly");
    document.getElementById("profitTaxRate").removeAttribute("readonly");
    return;
  }

  // Find the selected commodity data
  const selectedCommodity = commoditiesData.find(c => c.id === selectedCommodityId);

  if (!selectedCommodity) {
    console.error("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©");
    return;
  }

  // Determine which tariff to use based on selected region
  const selectedProvince = document.getElementById("region").value;
  const isNorth = isNorthernProvince(selectedProvince);
  const tariffRate = isNorth ? selectedCommodity.tariffNorth : selectedCommodity.tariffSouth;

  // Fill the fields with readonly attribute
  document.getElementById("tariffRate").value = tariffRate || 0;
  document.getElementById("salesTaxRate").value = selectedCommodity.salesTax || 0;
  document.getElementById("vatRate").value = selectedCommodity.vat || 0;
  document.getElementById("profitTaxRate").value = selectedCommodity.profitTax || 0;

  // Make fields readonly
  document.getElementById("tariffRate").setAttribute("readonly", "readonly");
  document.getElementById("salesTaxRate").setAttribute("readonly", "readonly");
  document.getElementById("vatRate").setAttribute("readonly", "readonly");
  document.getElementById("profitTaxRate").setAttribute("readonly", "readonly");

  console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©:", selectedCommodity);
}

// Handle region change to update tariff
function onRegionChange() {
  const commodityDropdown = document.getElementById("commodityType");
  const selectedCommodityId = commodityDropdown.value;

  if (!selectedCommodityId) {
    return; // No commodity selected, nothing to update
  }

  // Find the selected commodity data
  const selectedCommodity = commoditiesData.find(c => c.id === selectedCommodityId);

  if (!selectedCommodity) {
    return;
  }

  // Determine which tariff to use based on selected region
  const selectedProvince = document.getElementById("region").value;
  const isNorth = isNorthernProvince(selectedProvince);
  const tariffRate = isNorth ? selectedCommodity.tariffNorth : selectedCommodity.tariffSouth;

  // Update only the tariff field
  document.getElementById("tariffRate").value = tariffRate || 0;

  console.log("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¹Ø±ÙØ© Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©");
}

// Load data when page loads
window.addEventListener("DOMContentLoaded", function() {
  fetchFromMonday();
  fetchCommodityTypes();
  
  // Attach event listeners
  document.getElementById("commodityType").addEventListener("change", onCommodityChange);
  document.getElementById("region").addEventListener("change", onRegionChange);
});

function runCalculation() {
  const selectedProvince = document.getElementById("region").value;
  // Determine region type based on province
  const region = isNorthernProvince(selectedProvince) ? "north" : "south";
  
  const cifUsd = Number(document.getElementById("cifUsd").value);
  const tariffRate = Number(document.getElementById("tariffRate").value) / 100;

  const customsFxNorth = Number(document.getElementById("customsFxNorth").value);
  const customsFxSouth = Number(document.getElementById("customsFxSouth").value);
  const avgFxRate = Number(document.getElementById("avgFxRate").value);
  const southMarketFx = Number(document.getElementById("southMarketFx").value);

  const salesTaxRate = Number(document.getElementById("salesTaxRate").value) / 100;
  const vatRate = Number(document.getElementById("vatRate").value) / 100;
  const profitTaxRate = Number(document.getElementById("profitTaxRate").value) / 100;

  // ===================== Ø§Ù„Ø¬Ù†ÙˆØ¨ =====================
  const southCustomsValue = cifUsd * customsFxSouth;
  const southTariff = southCustomsValue * tariffRate;
  const southTaxable = southCustomsValue + southTariff;
  const southSalesTax = southTaxable * salesTaxRate;
  const southVat = southTaxable * vatRate;
  const southProfitTax = southTaxable * profitTaxRate;
  const southFixedFees = southCustomsValue * 0.02;

  const southPayableYER = southTariff + southSalesTax + southVat + southProfitTax + southFixedFees;
  const southPayableUSD = southPayableYER / southMarketFx;

  // ===================== Ø§Ù„Ø´Ù…Ø§Ù„ =====================
  const northCustomsValue = cifUsd * customsFxNorth;
  const northTariffHalf = northCustomsValue * (tariffRate / 2);
  const northMarketValue = cifUsd * avgFxRate;
  const northFullTariffForTax = northCustomsValue * tariffRate;
  const northTaxable = northMarketValue + northFullTariffForTax;
  const northSalesTax = northTaxable * salesTaxRate;
  const northVat = northTaxable * vatRate;
  const northProfitTax = northTaxable * profitTaxRate;
  const northFixedFees = (northCustomsValue * 0.06) + 3000;

  const northPayableYER = northTariffHalf + northSalesTax + northVat + northProfitTax + northFixedFees;
  const northPayableUSD = northPayableYER / avgFxRate;

  const finalPayableUSD = region === "north"
    ? southPayableUSD + northPayableUSD
    : southPayableUSD;

  let breakdownNorth = "";
  if (region === "north") {
    breakdownNorth = `
      <tr class="section"><td colspan="2">ØªØ­Ù„ÙŠÙ„ ØªØ­ØµÙŠÙ„ Ø§Ù„Ø´Ù…Ø§Ù„</td></tr>
      <tr class="tariff"><td>Ø§Ù„ØªØ¹Ø±ÙØ© (Ù†ØµÙ)</td><td>${northTariffHalf.toLocaleString()} Ø±ÙŠØ§Ù„</td></tr>
      <tr class="sales"><td>Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</td><td>${northSalesTax.toLocaleString()} Ø±ÙŠØ§Ù„</td></tr>
      <tr class="vat"><td>Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©</td><td>${northVat.toLocaleString()} Ø±ÙŠØ§Ù„</td></tr>
      <tr class="profit"><td>Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</td><td>${northProfitTax.toLocaleString()} Ø±ÙŠØ§Ù„</td></tr>
      <tr class="funds"><td>Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚</td><td>${northFixedFees.toLocaleString()} Ø±ÙŠØ§Ù„</td></tr>
      <tr><td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù…Ø§Ù„ (USD)</td><td>${northPayableUSD.toFixed(2)} USD</td></tr>
    `;
  }

  // ---------------- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨) ----------------

  const baseValues = `
  <table>
    <tr><th colspan="2">ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© Ù„Ù„Ø­Ø³Ø§Ø¨</th></tr>

    <tr class="section"><td colspan="2">Ø§Ù„Ø¬Ù†ÙˆØ¨</td></tr>
    <tr><td>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ© â€“ Ø¬Ù†ÙˆØ¨</td><td>${southCustomsValue.toLocaleString()} Ø±ÙŠØ§Ù„</td></tr>
    <tr><td>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ© â€“ Ø¬Ù†ÙˆØ¨</td><td>${southCustomsValue.toLocaleString()} Ø±ÙŠØ§Ù„</td></tr>
    <tr><td>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®Ø§Ø¶Ø¹Ø© Ù„Ù„Ø¶Ø±ÙŠØ¨Ø© â€“ Ø¬Ù†ÙˆØ¨</td><td>${southTaxable.toLocaleString()} Ø±ÙŠØ§Ù„</td></tr>

    <tr class="section"><td colspan="2">Ø§Ù„Ø´Ù…Ø§Ù„</td></tr>
    <tr><td>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ© â€“ Ø´Ù…Ø§Ù„</td><td>${northCustomsValue.toLocaleString()} Ø±ÙŠØ§Ù„</td></tr>
    <tr><td>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ© â€“ Ø´Ù…Ø§Ù„</td><td>${northMarketValue.toLocaleString()} Ø±ÙŠØ§Ù„</td></tr>
    <tr><td>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®Ø§Ø¶Ø¹Ø© Ù„Ù„Ø¶Ø±ÙŠØ¨Ø© â€“ Ø´Ù…Ø§Ù„</td><td>${northTaxable.toLocaleString()} Ø±ÙŠØ§Ù„</td></tr>
  </table>`;

  // ---------------- Ø¬Ø¯ÙˆÙ„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³ÙˆÙ… ----------------

  const results = `
  <table>
    <tr><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th></tr>

    <tr class="section"><td colspan="2">ØªØ­Ù„ÙŠÙ„ ØªØ­ØµÙŠÙ„ Ø§Ù„Ø¬Ù†ÙˆØ¨</td></tr>
    <tr class="tariff"><td>Ø§Ù„ØªØ¹Ø±ÙØ©</td><td>${southTariff.toLocaleString()} Ø±ÙŠØ§Ù„</td></tr>
    <tr class="sales"><td>Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</td><td>${southSalesTax.toLocaleString()} Ø±ÙŠØ§Ù„</td></tr>
    <tr class="vat"><td>Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©</td><td>${southVat.toLocaleString()} Ø±ÙŠØ§Ù„</td></tr>
    <tr class="profit"><td>Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</td><td>${southProfitTax.toLocaleString()} Ø±ÙŠØ§Ù„</td></tr>
    <tr class="funds"><td>Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚</td><td>${southFixedFees.toLocaleString()} Ø±ÙŠØ§Ù„</td></tr>
    <tr><td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ù†ÙˆØ¨ (USD)</td><td>${southPayableUSD.toFixed(2)} USD</td></tr>

    ${breakdownNorth}

    <tr class="total">
      <td>âœ… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„</td>
      <td>${finalPayableUSD.toFixed(2)} USD</td>
    </tr>
  </table>`;

  document.getElementById("results").innerHTML = results;
  document.getElementById("baseValues").innerHTML = baseValues;
}
</script>

</body>
</html>
